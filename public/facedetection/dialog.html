<html>
    <head>
        <title>Biauthorise</title>
        <script type="text/javascript" src="./face_files/jquery.min.js"></script>
        <script type="text/javascript" src="./face_files/jsfeat.js"></script>
        <script type="text/javascript" src="./face_files/compatibility.js"></script>
        <script type="text/javascript" src="./face_files/camgaze.js"></script>
        <script type="text/javascript" src="./face_files/frontalface.js"></script>
        <script text="text/javascript">
            var waiting = true;
            var imgURL;

            window.onload = function () {
                var width = 580;
                var height = 440;
                var cGaze = new camgaze.Camgaze(width, height, "mainCanvas");
                var faceDetector = new camgaze.CVUtil.HaarDetector(
                    camgaze.cascades.frontalface,
                    width,
                    height
                );
                var drawer = new camgaze.drawing.ImageDrawer();

                var frameOp = function (image_data, video) {

                    var faceRects = faceDetector.detectObjects(
                        video,
                        1.1,
                        1
                    );

                    if (!imgURL && faceRects.length == 1 && !waiting) {
                        var c = document.getElementById("mainCanvas");
                        imgURL = c.toDataURL("image/jpeg");
                        $("#statusNotifier").html("Photo taken");

                        var img = new Image();
                        img.src = imgURL;

                        var prev_c = document.getElementById("previewCanvas");
                        var ctx = prev_c.getContext("2d");
                        ctx.drawImage(img, 0, 0, width/4, height/4);
                        var authLink = window.opener.document.getElementById("biauth_authlink");

                        var tokenField = window.opener.document.createElement('input');
                        tokenField.value = "T0k3n_123";
                        tokenField.name = "biauth_token";
                        tokenField.type = "hidden";
                        tokenField.id = tokenField.name;

                        authLink.parentNode.insertBefore(tokenField,authLink);
                        authLink.parentNode.removeChild(authLink);
                        window.close();

                    }

                    return image_data;
                };
                cGaze.setFrameOperator(frameOp);

                if (waiting) {
                    waiting = false;
                    $("#statusNotifier").html("No face found yet");
                }
            } 
        </script>
    </head>
    <body>
        <canvas id="mainCanvas" height="440" width="580"></canvas>
        <canvas id="previewCanvas" height="110" width="145"></canvas>
        <video style="display: none;" autoplay=""></video>
        <div id="statusNotifier">Waiting for camera</div>
        <a href="javascript:window.location=imgURL;">View JPG</a>
    </body>
</html>